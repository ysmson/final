<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>æ¸¬é©—çµæœ</title>
  <style>
    body {
      margin: 0;
      background-color: #0d0d0d;
      font-family: "Microsoft JhengHei", sans-serif;
      padding-top: 72px;
      padding-bottom: 48px;
      color: white;
    }
    .result-summary {
      background-color: #222;
      padding: 24px;
      margin: 80px auto 24px auto;
      max-width: 720px;
      border-radius: 8px;
      text-align: center;
    }
    .button-group {
      margin-top: 16px;
    }
    button {
      padding: 10px 24px;
      background-color: #000;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      margin: 0 8px;
      transition: background 0.3s;
    }
    button:hover {
      background-color: #333;
    }
    .quiz-result {
      background-color: #1e1e1e;
      padding: 20px;
      margin: 16px auto;
      max-width: 720px;
      border-radius: 8px;
    }
    .quiz-result ul {
      list-style-type: none;
      padding-left: 0;
    }
    .quiz-result li {
      margin: 6px 0;
      padding: 6px 10px;
      border-radius: 4px;
    }
    .correct-option {
      background-color: #2ecc71;
      color: white;
      font-weight: bold;
    }
    .wrong-option {
      background-color: #e74c3c;
      color: white;
    }
    .normal-option {
      background-color: #444;
      color: #ccc;
    }
    footer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background-color: #fff;
      color: #000;
      text-align: center;
      padding: 12px;
      font-size: 14px;
      box-shadow: 0 -2px 6px rgba(0, 0, 0, 0.15);
      z-index: 999;
    }
    .section-title {
      text-align: center;
      margin-top: 32px;
      margin-bottom: 16px;
    }
  </style>
</head>
<body>

  <div class="result-summary">
    <h2>ğŸ“Š æ¸¬é©—çµæœ</h2>
    <p>ğŸ® å½±ç‰‡ IDï¼š<span id="video-id"></span></p>
    <p>ğŸ‘¤ ä½¿ç”¨è€… IDï¼š<span id="user-id"></span></p>
    <p>ğŸ“š é¡Œç›®ä¾†æºï¼š<span id="source"></span></p>
    <p>ğŸ“ ä½œç­”é¡Œæ•¸ï¼š<span id="total"></span></p>
    <p>âœ… ç­”å°é¡Œæ•¸ï¼š<span id="correct"></span></p>
    <p>ğŸ“‰ æ­£ç¢ºç‡ï¼š<span id="accuracy"></span></p>
    <div class="button-group">
      <button onclick="location.href='index.html'">ğŸ  å›é¦–é </button>
      <button id="backToHistory">ğŸ“– è¿”å›ç´€éŒ„</button>
    </div>
  </div>

  <div id="gptContainer"></div>
  <div id="localContainer"></div>

  <footer>å®¢æœä¿¡ç®±</footer>

  <script>
  document.addEventListener("DOMContentLoaded", () => {
	// ğŸ”¥ é¡¯ç¤ºæœ¬æ¬¡ç²å¾—ç¶“é©—å€¼
	  const quizResult = JSON.parse(localStorage.getItem("quizResult") || "{}");
	  const gainedExp = quizResult.gainedExp ?? (quizResult.correctCount * 10 || 0);

	  const expLine = document.createElement("p");
	  expLine.innerHTML = `ğŸŒŸ æœ¬æ¬¡ç²å¾—ç¶“é©—å€¼ï¼š<strong>${gainedExp}</strong> EXP`;
	  document.querySelector(".result-summary").appendChild(expLine);

	  // â³ 3 ç§’å¾Œæ¸…æ‰ localStorage é¿å…èˆŠè³‡æ–™æ®˜ç•™
	  setTimeout(() => localStorage.removeItem("quizResult"), 3000);

	  const contextPath = "/videotest";
    const params = new URLSearchParams(location.search);
    const videoId = params.get("videoId");
    const userId = parseInt(params.get("userId"));
    const attemptId = params.get("attemptId");
    const source = params.get("source") || "";

    document.getElementById("video-id").textContent = videoId;
    document.getElementById("user-id").textContent = userId;
    document.getElementById("source").textContent =
      source === "gpt" ? "GPT é¡Œç›®" :
      source === "local" ? "æœ¬åœ°é¡Œç›®" : "å…¨éƒ¨ä¾†æº";

    document.getElementById("backToHistory").onclick = () => {
      location.href = `quizhistory.html?userId=${userId}`;
    };

    function normalize(str) {
      return (str || "").replace(/[\s\p{P}\p{S}ï¼ˆï¼‰]+/gu, "").toLowerCase();
    }

    function getIndexes(item) {
      const options = [item.option1, item.option2, item.option3, item.option4];
      let userIndex = parseInt(item.selectedIndex ?? item.selected_option);
      if (isNaN(userIndex)) {
        const sel = (item.selected_option || "").toUpperCase();
        if (["A", "B", "C", "D"].includes(sel)) {
          userIndex = sel.charCodeAt(0) - 65;
        } else {
          const match = options.findIndex(opt => normalize(opt) === normalize(item.selected_option));
          if (match !== -1) userIndex = match;
        }
      }

      let correctIndex = parseInt(item.correctIndex ?? item.correct_index);
      if (isNaN(correctIndex) || correctIndex < 0 || correctIndex > 3) {
        const match = options.findIndex(opt => normalize(opt) === normalize(item.answer));
        if (match !== -1) correctIndex = match;
      }

      const isValid = userIndex >= 0 && correctIndex >= 0 && userIndex < 4 && correctIndex < 4;
      const isCorrect = isValid && userIndex === correctIndex;

      return { userIndex, correctIndex, options, isCorrect };
    }

    fetch(`${contextPath}/api/answerDetail?videoId=${videoId}&userId=${userId}&attemptId=${attemptId}`)
      .then(res => {
        if (!res.ok) throw new Error("API å›å‚³å¤±æ•—");
        return res.json();
      })
      .then(data => {
        let total = 0, correct = 0;

        data.forEach(item => {
          const { userIndex, correctIndex, isCorrect } = getIndexes(item);
          if (userIndex >= 0 && correctIndex >= 0) {
            total++;
            if (isCorrect) correct++;
          }
        });

        document.getElementById("total").textContent = total;
        document.getElementById("correct").textContent = correct;
        document.getElementById("accuracy").textContent =
          total > 0 ? `${((correct / total) * 100).toFixed(1)}%` : "N/A";

        ["gpt", "local"].forEach(type => {
          const label = type === "gpt" ? "ğŸ¤– GPT é¡Œç›®" : "ğŸ“˜ æœ¬åœ°é¡Œç›®";
          const container = type === "gpt" ? document.getElementById("gptContainer") : document.getElementById("localContainer");
          const filtered = data.filter(item => (item.source || "").toLowerCase() === type);
          if (!source || source === type) {
            renderQuestions(filtered, container, label);
          }
        });
      })
      .catch(err => {
        console.error("âŒ ç„¡æ³•è¼‰å…¥æ¸¬é©—è©³è§£ï¼š", err);
        alert("ç„¡æ³•è¼‰å…¥æ¸¬é©—çµæœï¼Œè«‹ç¨å¾Œå†è©¦");
      });

    function renderQuestions(questions, container, titleText) {
      if (questions.length === 0) return;
      const title = document.createElement("h2");
      title.className = "section-title";
      title.textContent = titleText;
      container.appendChild(title);

      questions.forEach((item, index) => {
        const { userIndex, correctIndex, options, isCorrect } = getIndexes(item);
        const icon = isCorrect ? "â­•" : "âŒ";

        const div = document.createElement("div");
        div.className = "quiz-result";
        div.innerHTML = `<h3>${index + 1}. ${icon}</h3><p><b>${item.question}</b></p>`;

        const ul = document.createElement("ul");
        options.forEach((opt, i) => {
          const li = document.createElement("li");
          li.textContent = `${String.fromCharCode(65 + i)}. ${opt}`;
          if (i === correctIndex) {
            li.className = "correct-option";
          } else if (i === userIndex && !isCorrect) {
            li.className = "wrong-option";
          } else {
            li.className = "normal-option";
          }
          ul.appendChild(li);
        });

        div.appendChild(ul);

        const explanation = document.createElement("p");
        explanation.innerHTML = `<em>ğŸ“ è©³è§£ï¼š</em> ${item.explanation || "ç„¡æä¾›"}`;
        div.appendChild(explanation);

        container.appendChild(div);
      });
    }
  });
</script>

</body>
</html>
